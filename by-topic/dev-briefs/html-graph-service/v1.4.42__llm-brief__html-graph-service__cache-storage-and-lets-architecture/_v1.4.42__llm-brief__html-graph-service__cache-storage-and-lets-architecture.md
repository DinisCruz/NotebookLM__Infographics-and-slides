# Html Graph Service - Cache Storage & LETS Architecture

**LLM Brief for Implementation**

**Version**: 1.0.0  
**Date**: January 2026  
**Service**: MGraph-AI Html Graph Service  
**Status**: Architecture Design - Ready for Implementation

---

## Table of Contents

1. [Executive Summary](#1-executive-summary)
2. [Problem Statement](#2-problem-statement)
3. [Solution Overview](#3-solution-overview)
4. [Architecture Overview](#4-architecture-overview)
5. [The LETS Framework](#5-the-lets-framework)
6. [Cache Storage Layer](#6-cache-storage-layer)
7. [Profiles System](#7-profiles-system)
8. [Type System Design](#8-type-system-design)
9. [Data Flow & Workflows](#9-data-flow--workflows)
10. [Schema Definitions](#10-schema-definitions)
11. [Implementation Classes](#11-implementation-classes)
12. [API Integration](#12-api-integration)
13. [Package Structure](#13-package-structure)
14. [Implementation Checklist](#14-implementation-checklist)

---

## 1. Executive Summary

### What We're Building

We are building a **cached HTML transformation pipeline** for the MGraph-AI Html Graph Service. This system enables:

1. **Multi-stage HTML transformations** with caching at each stage
2. **Full provenance and explainability** of what happened at each step
3. **Performance optimization** by reusing previously computed results
4. **Composable pipelines** where each transformation consumes the output of the previous one

### Why We're Building It

The Html Graph Service transforms HTML documents through multiple stages:

```
Raw HTML → HTML Dict → MGraph Document → Filtered HTML
```

Currently, each transformation is computed fresh every time, even for identical inputs. This creates several problems:

1. **Performance**: Repeated expensive computations
2. **Debugging**: No visibility into intermediate states
3. **Development**: Can't inspect or modify individual transformation steps
4. **Provenance**: No record of what transformations were applied

### How We're Building It

We're implementing two independent but complementary systems:

1. **LETS Framework**: A pipeline pattern where each transformation follows Load → Extract → Transform → Save phases
2. **Cache Storage Layer**: A two-tier storage system using the MGraph-AI Cache Service

The key insight is that **LETS is independent from caching** - the cache is just one possible target for the Load and Save phases. This separation enables:

- Testing transformations without cache infrastructure
- Swapping storage backends (memory, disk, remote)
- Running transformations with or without caching

---

## 2. Problem Statement

### Current State

The Html Graph Service provides endpoints to transform HTML:

```
POST /graph/from/html/to/{engine}/{transformation}
POST /graph/from/url/to/{engine}/{transformation}
```

Each request performs the full transformation pipeline from scratch:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        CURRENT STATE: No Caching                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Request 1: example.com/page-1
    ─────────────────────────────
    HTML String ──► Parse ──► Build Dict ──► Build MGraph ──► Transform ──► Response
                   (50ms)     (100ms)        (200ms)          (50ms)
                                                              Total: 400ms

    Request 2: example.com/page-1 (same page!)
    ──────────────────────────────────────────
    HTML String ──► Parse ──► Build Dict ──► Build MGraph ──► Transform ──► Response
                   (50ms)     (100ms)        (200ms)          (50ms)
                                                              Total: 400ms (repeated!)
```

### Problems

| Problem | Impact |
|---------|--------|
| **No caching** | Identical requests recompute everything |
| **No intermediate access** | Can't inspect HTML Dict or MGraph directly |
| **No provenance** | No record of what was computed or when |
| **Tight coupling** | Transformations embedded in request handlers |
| **No pipeline visibility** | Can't debug individual stages |

### Desired State

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        DESIRED STATE: With Caching                          │
└─────────────────────────────────────────────────────────────────────────────┘

    Request 1: example.com/page-1
    ─────────────────────────────
    HTML String ──► Parse ──► Build Dict ──► Build MGraph ──► Transform ──► Response
                   (50ms)     (100ms)        (200ms)          (50ms)
                     │           │              │                │
                     ▼           ▼              ▼                ▼
                  [Cache]    [Cache]        [Cache]          [Cache]
                                                              Total: 400ms

    Request 2: example.com/page-1 (same page!)
    ──────────────────────────────────────────
                  [Cache Hit] ─────────────────────────────► Response
                                                              Total: 5ms ✓
```

---

## 3. Solution Overview

### Two Independent Systems

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         SOLUTION ARCHITECTURE                                │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────┐     ┌─────────────────────────────────────┐
│         LETS FRAMEWORK          │     │        CACHE STORAGE LAYER          │
│                                 │     │                                     │
│  • Defines transformation       │     │  • Stores transformation outputs    │
│    pattern (L-E-T-S)           │     │  • Two-tier storage model           │
│  • Type-safe inputs/outputs    │     │  • Root document as state manager   │
│  • Pipeline composition        │     │  • Layer-based organization         │
│  • Profile-based execution     │     │  • Cache service integration        │
│                                 │     │                                     │
│  INDEPENDENT - works without   │     │  INDEPENDENT - works with any       │
│  any cache infrastructure      │     │  data source, not just LETS         │
└─────────────────────────────────┘     └─────────────────────────────────────┘
                │                                        │
                │         ┌──────────────────┐          │
                └────────►│   INTEGRATION    │◄─────────┘
                          │                  │
                          │  LETS uses Cache │
                          │  for Load/Save   │
                          │  phases          │
                          └──────────────────┘
```

### Key Design Principles

| Principle | Implementation |
|-----------|----------------|
| **No raw primitives** | All `str`, `int`, `dict`, `list` replaced with `Safe_*` types |
| **Schemas are pure data** | No methods in `Schema__*` classes |
| **LETS is cache-independent** | Cache is just one Load/Save target |
| **Type[X] for class references** | Enables JSON serialization of class references |
| **Enum values ARE classes** | Direct mapping, no lookup needed |
| **Root document as state manager** | Single source of truth for document state |

---

## 4. Architecture Overview

### System Architecture

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           SYSTEM ARCHITECTURE                                │
└─────────────────────────────────────────────────────────────────────────────┘

                                    API Layer
                                       │
            ┌──────────────────────────┼──────────────────────────┐
            │                          │                          │
            ▼                          ▼                          ▼
    ┌───────────────┐         ┌───────────────┐         ┌───────────────┐
    │ /graph/from/  │         │ /graph/from/  │         │  /cache/...   │
    │ html/to/...   │         │ url/to/...    │         │  (new)        │
    └───────┬───────┘         └───────┬───────┘         └───────┬───────┘
            │                          │                          │
            │    Schema__Html_Cache__Settings (optional)          │
            │                          │                          │
            └──────────────────────────┼──────────────────────────┘
                                       │
                                       ▼
                          ┌────────────────────────┐
                          │   Html_LETS__Executor  │
                          │                        │
                          │  • Runs LETS pipeline  │
                          │  • Manages caching     │
                          │  • Tracks status       │
                          └───────────┬────────────┘
                                      │
                    ┌─────────────────┼─────────────────┐
                    │                 │                 │
                    ▼                 ▼                 ▼
           ┌──────────────┐  ┌──────────────┐  ┌──────────────┐
           │ Html_LETS__  │  │ Html_LETS__  │  │ Html_LETS__  │
           │ Html__To__   │  │ Dict__To__   │  │ MGraph__To__ │
           │ Dict         │  │ MGraph       │  │ Html         │
           └──────┬───────┘  └──────┬───────┘  └──────┬───────┘
                  │                 │                 │
                  │    Each LETS: Load-Extract-Transform-Save
                  │                 │                 │
                  └─────────────────┼─────────────────┘
                                    │
                                    ▼
                          ┌────────────────────────┐
                          │  Html_Cache__Document  │
                          │                        │
                          │  • Root doc = state    │
                          │  • Layer access        │
                          │  • Cache operations    │
                          └───────────┬────────────┘
                                      │
                                      ▼
                          ┌────────────────────────┐
                          │  Html_Cache__Client    │
                          │                        │
                          │  • Cache service API   │
                          │  • Two-tier storage    │
                          └───────────┬────────────┘
                                      │
                                      ▼
                          ┌────────────────────────┐
                          │  MGraph-AI Cache       │
                          │  Service               │
                          │                        │
                          │  • S3 / In-Memory      │
                          │  • Key-based storage   │
                          └────────────────────────┘
```

### Component Responsibilities

| Component | Responsibility |
|-----------|----------------|
| **Html_LETS__Executor** | Orchestrates LETS pipeline execution |
| **Html_LETS__Base** | Base class for all transformations |
| **Html_LETS__**** | Concrete transformation implementations |
| **Schema__LETS__Profile** | Defines pipeline composition |
| **Html_Cache__Document** | Manages cached document state |
| **Html_Cache__Layer** | Provides access to single cache layer |
| **Html_Cache__Client** | Wraps cache service API |
| **Schema__Html_Cache__Root** | Root document (state manager) |

---

## 5. The LETS Framework

### What is LETS?

LETS is a **transformation pattern** with four phases:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           THE LETS PATTERN                                   │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────┐      ┌─────────┐      ┌───────────┐      ┌─────────┐
    │  LOAD   │ ───► │ EXTRACT │ ───► │ TRANSFORM │ ───► │  SAVE   │
    └─────────┘      └─────────┘      └───────────┘      └─────────┘
         │                │                 │                 │
         ▼                ▼                 ▼                 ▼
    Get input        Extract the       Do the actual     Save the
    data from        relevant data     transformation    output for
    source           from loaded       work              future use
                     input

    Type_Safe ──────► Type_Safe ──────► Type_Safe ──────► Type_Safe
    Input             Input             Input             Output
```

### Phase Definitions

| Phase | Purpose | Input | Output |
|-------|---------|-------|--------|
| **Load** | Get input data from source (cache, context, previous LETS) | `Schema__LETS__Load__Input` | `Schema__LETS__Load__Output` |
| **Extract** | Extract relevant data from loaded input (often pass-through) | `Schema__LETS__Extract__Input` | `Schema__LETS__Extract__Output` |
| **Transform** | Perform the actual transformation work | `Schema__LETS__Transform__Input` | `Schema__LETS__Transform__Output` |
| **Save** | Save the output for future use | `Schema__LETS__Save__Input` | `Schema__LETS__Save__Output` |

### LETS Class Hierarchy

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        LETS CLASS HIERARCHY                                  │
└─────────────────────────────────────────────────────────────────────────────┘

                              Html_LETS__Base
                                    │
                                    │ (abstract)
                                    │
        ┌───────────────────────────┼───────────────────────────┐
        │                           │                           │
        ▼                           ▼                           ▼
Html_LETS__Html__         Html_LETS__Dict__          Html_LETS__MGraph__
From__Raw                 To__MGraph                 To__Html
        │                           │                           │
        │                           │                           │
        ▼                           ▼                           ▼
Html_LETS__Html__         Html_LETS__Html__          Html_LETS__MGraph__
From__Url                 To__Dict                   To__Html_Dict
                                    │
                                    │
                                    ▼
                          Html_LETS__Html_Dict__
                          To__Html
```

### LETS Enum Mapping

The enum maps names to class types directly:

```python
class Enum__Html_LETS__Type(Enum):
    HTML_FROM_RAW         = Html_LETS__Html__From__Raw       # Value IS the class
    HTML_FROM_URL         = Html_LETS__Html__From__Url
    HTML_TO_DICT          = Html_LETS__Html__To__Dict
    DICT_TO_MGRAPH        = Html_LETS__Dict__To__MGraph
    MGRAPH_TO_HTML_DICT   = Html_LETS__MGraph__To__Html_Dict
    MGRAPH_TO_HTML        = Html_LETS__MGraph__To__Html
    HTML_DICT_TO_HTML     = Html_LETS__Html_Dict__To__Html
```

**Key insight**: Enum values ARE the class types. This enables:

```python
# Direct class access
lets_class = Enum__Html_LETS__Type.HTML_TO_DICT.value
instance   = lets_class()

# String auto-conversion with @type_safe
@type_safe
def get_lets(lets_type: Enum__Html_LETS__Type) -> Type[Html_LETS__Base]:
    return lets_type.value

get_lets('HTML_TO_DICT')  # String auto-converts to enum
```

### LETS Pipeline Execution

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        LETS PIPELINE EXECUTION                               │
└─────────────────────────────────────────────────────────────────────────────┘

    Profile: "standard-html-to-mgraph"
    Pipeline: [Html_LETS__Html__To__Dict, Html_LETS__Dict__To__MGraph]

    Input Context (HTML string)
              │
              ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │                   LETS 1: Html__To__Dict                            │
    │                                                                     │
    │   Load ──────► Extract ──────► Transform ──────► Save              │
    │     │                              │                │              │
    │     ▼                              ▼                ▼              │
    │   Get HTML                    Parse HTML      Save HTML Dict       │
    │   from context               to dictionary    to cache layer       │
    │                                                                     │
    │   Output: HTML Dict                                                 │
    └─────────────────────────────────────────────────────────────────────┘
              │
              │ (output becomes input for next LETS)
              ▼
    ┌─────────────────────────────────────────────────────────────────────┐
    │                   LETS 2: Dict__To__MGraph                          │
    │                                                                     │
    │   Load ──────► Extract ──────► Transform ──────► Save              │
    │     │                              │                │              │
    │     ▼                              ▼                ▼              │
    │   Get HTML Dict               Build MGraph     Save MGraph         │
    │   from previous LETS          from dict        to cache layer      │
    │                                                                     │
    │   Output: MGraph Document                                           │
    └─────────────────────────────────────────────────────────────────────┘
              │
              ▼
    Final Output (MGraph Document)
```

---

## 6. Cache Storage Layer

### Two-Tier Storage Model

The cache service uses a **two-tier storage model**:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                        TWO-TIER STORAGE MODEL                                │
└─────────────────────────────────────────────────────────────────────────────┘

TIER 1: ENTRY STORAGE (creates ~5 files)
─────────────────────────────────────────

    Creates the "anchor" entry and establishes the cache_id

    ┌─────────────────────────────────────────────────────────────────────┐
    │  {namespace}/data/key-based/{cache_key}/{file_id}/                  │
    │  ├── html-entry.json              ← Root document (state manager)   │
    │  ├── html-entry.json.config       ← Storage configuration           │
    │  └── html-entry.json.metadata     ← Tracking info                   │
    │                                                                     │
    │  refs/by-hash/{sharded_hash}.json ← Hash → cache_id mapping        │
    │  refs/by-id/{sharded_id}.json     ← ID → full refs                 │
    └─────────────────────────────────────────────────────────────────────┘
                                │
                                │ cache_id (UUID)
                                ▼

TIER 2: DATA STORAGE (creates 1 file per layer)
───────────────────────────────────────────────

    Stores transformation outputs, anchored to parent cache_id

    ┌─────────────────────────────────────────────────────────────────────┐
    │  {namespace}/data/key-based/{cache_key}/{file_id}/data/             │
    │  ├── html-to-dict/                                                  │
    │  │   └── html-dict.json           ← LETS output                    │
    │  ├── dict-to-mgraph/                                                │
    │  │   └── mgraph-document.json     ← LETS output                    │
    │  └── mgraph-to-html/                                                │
    │      └── html-output.json         ← LETS output                    │
    └─────────────────────────────────────────────────────────────────────┘
```

### The Three Identifiers

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         THE THREE IDENTIFIERS                                │
└─────────────────────────────────────────────────────────────────────────────┘

    ┌─────────────────┐
    │    cache_key    │  Semantic path (human-readable)
    │                 │  Example: "example.com/blog/post-1"
    │  DETERMINISTIC  │  Controlled by caller
    └────────┬────────┘
             │
             │ hash(cache_key)
             ▼
    ┌─────────────────┐
    │   cache_hash    │  16-char hex hash
    │                 │  Example: "a1b2c3d4e5f67890"
    │  DETERMINISTIC  │  Same cache_key always produces same hash
    └────────┬────────┘
             │
             │ refs/by-hash lookup
             ▼
    ┌─────────────────┐
    │    cache_id     │  UUID (unique entry identifier)
    │                 │  Example: "550e8400-e29b-41d4-a716-446655440000"
    │  NOT DETERMIN.  │  Generated on first entry creation
    └─────────────────┘

LOOKUP CHAIN:
─────────────
    cache_key ──hash()──► cache_hash ──refs lookup──► cache_id ──► data access
```

### Root Document as State Manager

The root document (`html-entry.json`) serves as the **state manager** for all transformations:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    ROOT DOCUMENT AS STATE MANAGER                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Schema__Html_Cache__Root
    ┌─────────────────────────────────────────────────────────────────────┐
    │                                                                     │
    │  cache_key: "example.com/blog/post-1"     ← Identity               │
    │                                                                     │
    │  source_type: "url"                       ← How HTML was obtained  │
    │  source_url: "https://example.com/..."                              │
    │  source_hash: "a1b2c3d4..."               ← For cache invalidation │
    │                                                                     │
    │  profile_id: "standard-html-to-mgraph"    ← Which profile used     │
    │                                                                     │
    │  transformations: {                       ← Status of each LETS    │
    │      "html-to-dict": {                                              │
    │          name: "html-to-dict",                                      │
    │          completed: true,                                           │
    │          data_key: "html-to-dict",                                  │
    │          file_id: "html-dict",                                      │
    │          timestamp: 1705123456789,                                  │
    │          duration_ms: 150                                           │
    │      },                                                             │
    │      "dict-to-mgraph": {                                            │
    │          name: "dict-to-mgraph",                                    │
    │          completed: true,                                           │
    │          ...                                                        │
    │      }                                                              │
    │  }                                                                  │
    │                                                                     │
    │  created_at: 1705123456000                                          │
    │  updated_at: 1705123457000                                          │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘

    The root document tells us:
    ✓ What transformations have been completed
    ✓ Where each output is stored (data_key + file_id)
    ✓ When each was computed (timestamp)
    ✓ How long each took (duration_ms)
    ✓ What profile was used
    ✓ Where the source HTML came from
```

### Cache Layer Access Pattern

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                       CACHE LAYER ACCESS PATTERN                             │
└─────────────────────────────────────────────────────────────────────────────┘

    Html_Cache__Document
           │
           │ .layer("html-to-dict")
           ▼
    Html_Cache__Layer
           │
           ├── .save_json(file_id, data)      ─► Store LETS output
           ├── .load_json(file_id)            ─► Retrieve LETS output
           ├── .save_string(file_id, content) ─► Store raw HTML
           ├── .load_string(file_id)          ─► Retrieve raw HTML
           ├── .exists(file_id)               ─► Check if cached
           └── .delete(file_id)               ─► Remove cached data

    All operations automatically:
    • Resolve cache_id from cache_key
    • Use correct namespace
    • Build correct data_key path
```

---

## 7. Profiles System

### What is a Profile?

A **Profile** defines a pipeline of LETS transformations to execute:

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PROFILES SYSTEM                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    Schema__LETS__Profile
    ┌─────────────────────────────────────────────────────────────────────┐
    │                                                                     │
    │  profile_id:   "standard-html-to-mgraph"                           │
    │  profile_name: "Standard HTML Processing"                           │
    │  description:  "Parse HTML and build MGraph document"               │
    │                                                                     │
    │  lets_pipeline: [                                                   │
    │      Html_LETS__Html__To__Dict,      ← Type[Html_LETS__Base]       │
    │      Html_LETS__Dict__To__MGraph                                    │
    │  ]                                                                  │
    │                                                                     │
    └─────────────────────────────────────────────────────────────────────┘

    Serializes to JSON as:
    {
        "profile_id": "standard-html-to-mgraph",
        "profile_name": "Standard HTML Processing",
        "description": "Parse HTML and build MGraph document",
        "lets_pipeline": [
            "mgraph_ai_service_html_graph.lets.Html_LETS__Html__To__Dict",
            "mgraph_ai_service_html_graph.lets.Html_LETS__Dict__To__MGraph"
        ]
    }

    Note: Type[X] serializes to fully-qualified class name string
          Type_Safe.from_json() reconstructs the class reference
```

### Standard Profiles

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STANDARD PROFILES                                    │
└─────────────────────────────────────────────────────────────────────────────┘

PROFILE: html-to-dict
─────────────────────
    Input: Raw HTML string
    Output: HTML Dictionary with node IDs
    Pipeline: [Html_LETS__Html__To__Dict]


PROFILE: html-to-mgraph
───────────────────────
    Input: Raw HTML string
    Output: MGraph Document
    Pipeline: [Html_LETS__Html__To__Dict,
               Html_LETS__Dict__To__MGraph]


PROFILE: full-roundtrip
───────────────────────
    Input: Raw HTML string
    Output: Reconstructed HTML
    Pipeline: [Html_LETS__Html__To__Dict,
               Html_LETS__Dict__To__MGraph,
               Html_LETS__MGraph__To__Html_Dict,
               Html_LETS__Html_Dict__To__Html]


PROFILE: url-to-mgraph
──────────────────────
    Input: URL
    Output: MGraph Document
    Pipeline: [Html_LETS__Html__From__Url,
               Html_LETS__Html__To__Dict,
               Html_LETS__Dict__To__MGraph]
```

---

## 8. Type System Design

### No Raw Primitives

**Critical Rule**: Never use raw `str`, `int`, `dict`, `list` in Type_Safe classes.

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         NO RAW PRIMITIVES                                    │
└─────────────────────────────────────────────────────────────────────────────┘

    ✗ WRONG                              ✓ CORRECT
    ─────────────────────────────────    ─────────────────────────────────
    name: str                            name: Safe_Str__LETS__Name
    count: int                           count: Safe_UInt
    data: dict                           data: Dict__LETS__Status__By_Name
    items: list                          items: List__LETS__Results
    status: str                          status: Enum__Source_Type
```

### Safe String Types for This System

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Safe String Types
# ═══════════════════════════════════════════════════════════════════════════════

class Safe_Str__LETS__Name(Safe_Str):          # LETS transformation name
    max_length = 64                             # e.g., "html-to-dict"
    regex      = re.compile(r'[^a-zA-Z0-9_\-]')

class Safe_Str__LETS__Data_Key(Safe_Str):      # LETS data path key
    max_length = 128                            # e.g., "html-to-dict/v2"
    regex      = re.compile(r'[^a-zA-Z0-9_\-/]')

class Safe_Str__Cache_Key(Safe_Str):           # Cache semantic path
    max_length = 512                            # e.g., "example.com/blog/post-1"
    regex      = re.compile(r'[^a-zA-Z0-9_\-/\.]')

class Safe_Str__Layer_Name(Safe_Str):          # Cache layer name
    max_length = 32                             # e.g., "html-to-dict"
    regex      = re.compile(r'[^a-zA-Z0-9_\-]')
```

### Typed Collections

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Typed Collections (pure type definitions - no methods)
# ═══════════════════════════════════════════════════════════════════════════════

class Dict__LETS__Status__By_Name(Type_Safe__Dict):   # Status dict by LETS name
    expected_key_type   = Safe_Str__LETS__Name
    expected_value_type = Schema__LETS__Status

class List__LETS__Results(Type_Safe__List):           # List of LETS results
    expected_type = Schema__LETS__Result

class List__LETS__Names(Type_Safe__List):             # List of LETS names
    expected_type = Safe_Str__LETS__Name

class List__LETS__Classes(Type_Safe__List):           # List of LETS class types
    expected_type = Type[Html_LETS__Base]
```

### Type[X] for Class References

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                      TYPE[X] FOR CLASS REFERENCES                            │
└─────────────────────────────────────────────────────────────────────────────┘

    Type[Html_LETS__Base] in a Type_Safe class:

    1. ASSIGNMENT
       ───────────
       profile.lets_pipeline = [Html_LETS__Html__To__Dict]
                                      │
                                      └─► Stores class type

    2. JSON SERIALIZATION
       ──────────────────
       profile.json()
       ───────────────────────────────────────────────────────────
       {
           "lets_pipeline": [
               "mgraph_ai_service_html_graph.lets.Html_LETS__Html__To__Dict"
           ]                    │
       }                        └─► Fully-qualified class name string

    3. JSON DESERIALIZATION
       ────────────────────
       Schema__LETS__Profile.from_json(json_data)
                                      │
                                      └─► Reconstructs class reference

    4. USAGE
       ─────
       for lets_class in profile.lets_pipeline:
           instance = lets_class()    ← Instantiate the class
           instance.transform(...)
```

---

## 9. Data Flow & Workflows

### Workflow 1: First Request (Cache Miss)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    WORKFLOW: FIRST REQUEST (CACHE MISS)                      │
└─────────────────────────────────────────────────────────────────────────────┘

    POST /graph/from/html/to/dot/default
    Body: { html: "<html>...", cache_settings: { enabled: true, ... } }

    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 1. API HANDLER                                                          │
    │    • Parse request                                                      │
    │    • Extract cache_settings                                             │
    │    • Create Html_Cache__Document if caching enabled                     │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 2. CACHE DOCUMENT CREATION                                              │
    │    • Generate cache_key from URL/hash                                   │
    │    • Check if entry exists (cache_hash lookup)                         │
    │    • Entry NOT found → Create new entry                                │
    │    • Get cache_id                                                       │
    │    • Load/create root document                                          │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 3. EXECUTOR RUNS PIPELINE                                               │
    │                                                                         │
    │    For each LETS in profile.lets_pipeline:                             │
    │    ┌─────────────────────────────────────────────────────────────────┐ │
    │    │ a. Check cache: layer.exists(file_id)                          │ │
    │    │    → NOT FOUND (first request)                                 │ │
    │    │                                                                 │ │
    │    │ b. Execute LETS phases:                                        │ │
    │    │    Load()      ─► Get input from context/previous LETS        │ │
    │    │    Extract()   ─► Extract relevant data                       │ │
    │    │    Transform() ─► Do transformation work                      │ │
    │    │    Save()      ─► Save to cache layer                         │ │
    │    │                                                                 │ │
    │    │ c. Update root document:                                       │ │
    │    │    root.transformations[name] = status                        │ │
    │    │    document.save_root()                                        │ │
    │    └─────────────────────────────────────────────────────────────────┘ │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 4. RETURN RESPONSE                                                      │
    │    • Final LETS output                                                  │
    │    • Include cache_id for future requests                              │
    │    • Include execution stats                                            │
    └─────────────────────────────────────────────────────────────────────────┘
```

### Workflow 2: Subsequent Request (Cache Hit)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                   WORKFLOW: SUBSEQUENT REQUEST (CACHE HIT)                   │
└─────────────────────────────────────────────────────────────────────────────┘

    POST /graph/from/html/to/dot/default
    Body: { html: "<html>...", cache_settings: { enabled: true, ... } }

    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 1. API HANDLER                                                          │
    │    • Parse request                                                      │
    │    • Extract cache_settings                                             │
    │    • Create Html_Cache__Document                                        │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 2. CACHE DOCUMENT LOOKUP                                                │
    │    • Generate cache_key (same as before)                               │
    │    • Check if entry exists (cache_hash lookup)                         │
    │    • Entry FOUND → Get existing cache_id                               │
    │    • Load existing root document                                        │
    │    • Root shows: transformations already completed!                    │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 3. EXECUTOR CHECKS CACHE                                                │
    │                                                                         │
    │    For each LETS in profile.lets_pipeline:                             │
    │    ┌─────────────────────────────────────────────────────────────────┐ │
    │    │ a. Check cache: layer.exists(file_id)                          │ │
    │    │    → FOUND! (subsequent request)                               │ │
    │    │                                                                 │ │
    │    │ b. Load from cache:                                            │ │
    │    │    data = layer.load_json(file_id)                             │ │
    │    │                                                                 │ │
    │    │ c. Skip execution - use cached result                          │ │
    │    │    from_cache = True                                           │ │
    │    └─────────────────────────────────────────────────────────────────┘ │
    │                                                                         │
    │    Total time: ~5ms (vs 400ms for full computation)                    │
    └───────────────────────────────────┬─────────────────────────────────────┘
                                        │
                                        ▼
    ┌─────────────────────────────────────────────────────────────────────────┐
    │ 4. RETURN RESPONSE                                                      │
    │    • Cached LETS output                                                 │
    │    • from_cache: true in stats                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

### Workflow 3: Force Rebuild Specific Layer

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    WORKFLOW: FORCE REBUILD SPECIFIC LAYER                    │
└─────────────────────────────────────────────────────────────────────────────┘

    POST /graph/from/html/to/dot/default
    Body: {
        html: "<html>...",
        cache_settings: {
            enabled: true,
            force_layers: ["dict-to-mgraph"]    ← Force this layer only
        }
    }

    Execution:
    ┌─────────────────────────────────────────────────────────────────────────┐
    │                                                                         │
    │    LETS: html-to-dict                                                   │
    │    • Check force_layers: NOT in list                                   │
    │    • Check cache: EXISTS                                                │
    │    • Action: USE CACHED ✓                                              │
    │                                                                         │
    │    LETS: dict-to-mgraph                                                 │
    │    • Check force_layers: IN LIST!                                      │
    │    • Action: FORCE REBUILD                                             │
    │    • Execute all phases                                                 │
    │    • Save new output                                                    │
    │    • Update status                                                      │
    │                                                                         │
    └─────────────────────────────────────────────────────────────────────────┘
```

---

## 10. Schema Definitions

### LETS Schemas

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Base Input/Output Schemas (Pure Data - No Methods)
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Input(Type_Safe):                                            # Base LETS input
    pass


class Schema__LETS__Output(Type_Safe):                                           # Base LETS output
    pass


# ═══════════════════════════════════════════════════════════════════════════════
# Phase-Specific Schemas
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Load__Input(Type_Safe):                                      # Load phase input
    pass


class Schema__LETS__Load__Output(Type_Safe):                                     # Load phase output
    pass


class Schema__LETS__Extract__Input(Type_Safe):                                   # Extract phase input
    pass


class Schema__LETS__Extract__Output(Type_Safe):                                  # Extract phase output
    pass


class Schema__LETS__Transform__Input(Type_Safe):                                 # Transform phase input
    pass


class Schema__LETS__Transform__Output(Type_Safe):                                # Transform phase output
    pass


class Schema__LETS__Save__Input(Type_Safe):                                      # Save phase input
    pass


class Schema__LETS__Save__Output(Type_Safe):                                     # Save phase output
    success : bool


# ═══════════════════════════════════════════════════════════════════════════════
# LETS Configuration
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Config(Type_Safe):                                           # LETS transformation config
    name           : Safe_Str__LETS__Name                                        # Unique name
    description    : Safe_Str__Text                                              # Human readable
    schema__input  : Type[Schema__LETS__Input ]  = None                          # Expected input schema
    schema__output : Type[Schema__LETS__Output]  = None                          # Expected output schema


# ═══════════════════════════════════════════════════════════════════════════════
# LETS Status (tracks execution state)
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Status(Type_Safe):                                           # Status of one execution
    name         : Safe_Str__LETS__Name                                          # LETS name
    completed    : bool                                                          # Has been executed
    data_key     : Safe_Str__LETS__Data_Key                                      # Cache path
    file_id      : Safe_Str__Id                                                  # Output file name
    timestamp    : Timestamp_Now           = None                                # When executed
    duration_ms  : Safe_UInt               = 0                                   # Execution time
    input_hash   : Safe_Str__Hash          = None                                # For invalidation
    output_hash  : Safe_Str__Hash          = None                                # For verification


# ═══════════════════════════════════════════════════════════════════════════════
# LETS Result
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Result(Type_Safe):                                           # Result of execution
    lets_name    : Safe_Str__LETS__Name                                          # Which LETS ran
    success      : bool                                                          # Did it complete
    from_cache   : bool                                                          # From cache?
    duration_ms  : Safe_UInt               = 0                                   # Execution time
    error        : Safe_Str__Text          = None                                # Error if failed
```

### Profile Schema

```python
# ═══════════════════════════════════════════════════════════════════════════════
# LETS Profile
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__LETS__Profile(Type_Safe):                                          # Pipeline definition
    profile_id    : Safe_Str__Id                                                 # Unique identifier
    profile_name  : Safe_Str__Text                                               # Human readable
    description   : Safe_Str__Text                                               # What it does
    lets_pipeline : List[Type[Html_LETS__Base]]                                  # Ordered LETS classes
```

### Cache Schemas

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Source Type Enum
# ═══════════════════════════════════════════════════════════════════════════════

class Enum__Source_Type(str, Enum):                                              # HTML source type
    RAW_HTML = 'raw_html'                                                        # Direct submission
    URL      = 'url'                                                             # Fetched from URL


# ═══════════════════════════════════════════════════════════════════════════════
# Typed Collection
# ═══════════════════════════════════════════════════════════════════════════════

class Dict__LETS__Status__By_Name(Type_Safe__Dict):                              # Status by name
    expected_key_type   = Safe_Str__LETS__Name
    expected_value_type = Schema__LETS__Status


# ═══════════════════════════════════════════════════════════════════════════════
# Cache Root Document (State Manager)
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__Html_Cache__Root(Type_Safe):                                       # Root document
    # Identity
    cache_key       : Safe_Str__Cache_Key                                        # Semantic path

    # Source information
    source_type     : Enum__Source_Type                                          # How obtained
    source_url      : Safe_Str__Url         = None                               # Original URL
    source_hash     : Safe_Str__Hash        = None                               # Content hash

    # Profile
    profile_id      : Safe_Str__Id          = 'default'                          # Profile used

    # Transformation state
    transformations : Dict__LETS__Status__By_Name                                # Each LETS status

    # Timestamps
    created_at      : Timestamp_Now
    updated_at      : Timestamp_Now         = None


# ═══════════════════════════════════════════════════════════════════════════════
# Cache Entry (for entry creation)
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__Html_Cache__Entry(Type_Safe):                                      # Entry for creation
    cache_key  : Safe_Str__Cache_Key                                             # Used for hash lookup


# ═══════════════════════════════════════════════════════════════════════════════
# API Cache Settings
# ═══════════════════════════════════════════════════════════════════════════════

class List__LETS__Names(Type_Safe__List):                                        # List of names
    expected_type = Safe_Str__LETS__Name


class Schema__Html_Cache__Settings(Type_Safe):                                   # API request settings
    enabled      : bool                      = False                             # Enable caching
    namespace    : Safe_Str__Namespace       = 'html-graph'                      # Namespace
    cache_key    : Safe_Str__Cache_Key       = None                              # Semantic path
    cache_id     : Cache_Id                  = None                              # Direct ID
    file_id      : Safe_Str__Id              = 'html-entry'                      # Entry name
    profile_id   : Safe_Str__Id              = 'default'                         # Profile
    force_layers : List__LETS__Names         = None                              # Force rebuild
```

---

## 11. Implementation Classes

### Html_LETS__Base

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Html_LETS__Base - Base class for all LETS transformations
# ═══════════════════════════════════════════════════════════════════════════════

class Html_LETS__Base(Type_Safe):                                                # Base LETS class
    config : Schema__LETS__Config                                                # Configuration

    # ═══════════════════════════════════════════════════════════════════════════
    # The 4 LETS Phases
    # ═══════════════════════════════════════════════════════════════════════════

    @type_safe
    def load(self                                   ,                            # Load input data
             load_input: Schema__LETS__Load__Input
        ) -> Schema__LETS__Load__Output:
        raise NotImplementedError

    @type_safe
    def extract(self                                      ,                      # Extract relevant data
                extract_input: Schema__LETS__Extract__Input
           ) -> Schema__LETS__Extract__Output:
        return extract_input                                                     # Default: pass through

    @type_safe
    def transform(self                                        ,                  # Transform data
                  transform_input: Schema__LETS__Transform__Input
             ) -> Schema__LETS__Transform__Output:
        raise NotImplementedError

    @type_safe
    def save(self                                 ,                              # Save output
             save_input: Schema__LETS__Save__Input
        ) -> Schema__LETS__Save__Output:
        raise NotImplementedError
```

### Html_LETS__Executor

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Html_LETS__Executor - Executes LETS pipelines
# ═══════════════════════════════════════════════════════════════════════════════

class List__LETS__Results(Type_Safe__List):                                      # Results list
    expected_type = Schema__LETS__Result


class Html_LETS__Executor(Type_Safe):                                            # Pipeline executor
    document : Html_Cache__Document = None                                       # Cache document

    @type_safe
    def execute_single(self                                     ,                # Execute one LETS
                       lets_class : Type[Html_LETS__Base]       ,                # LETS class
                       context    : Schema__LETS__Input                          # Input context
                  ) -> Schema__LETS__Result:
        pass                                                                     # Implementation

    @type_safe
    def execute_pipeline(self                                      ,             # Execute pipeline
                         lets_classes : List[Type[Html_LETS__Base]],             # LETS classes
                         context      : Schema__LETS__Input                      # Initial input
                    ) -> List__LETS__Results:
        results = List__LETS__Results()
        for lets_class in lets_classes:
            result = self.execute_single(lets_class = lets_class,
                                         context    = context   )
            results.append(result)
        return results

    @type_safe
    def execute_profile(self                            ,                        # Execute profile
                        profile : Schema__LETS__Profile ,                        # Profile
                        context : Schema__LETS__Input                            # Input
                   ) -> List__LETS__Results:
        return self.execute_pipeline(lets_classes = profile.lets_pipeline,
                                     context      = context              )
```

### Html_Cache__Document

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Html_Cache__Document - Manages cached document state
# ═══════════════════════════════════════════════════════════════════════════════

class Html_Cache__Document(Type_Safe):                                           # Document manager
    client     : Html_Cache__Client                                              # Cache client
    namespace  : Safe_Str__Namespace                                             # Namespace
    cache_key  : Safe_Str__Cache_Key                                             # Semantic path
    file_id    : Safe_Str__Id            = 'html-entry'                          # Entry name
    cache_id   : Cache_Id                = None                                  # Resolved ID
    root       : Schema__Html_Cache__Root = None                                 # Root document

    @type_safe
    def ensure_cache_id(self) -> Cache_Id:                                       # Get/create ID
        pass                                                                     # Implementation

    @type_safe
    def create_entry(self) -> Cache_Id:                                          # Create entry
        pass                                                                     # Implementation

    @type_safe
    def load_root(self) -> Schema__Html_Cache__Root:                             # Load root
        pass                                                                     # Implementation

    @type_safe
    def save_root(self) -> bool:                                                 # Save root
        pass                                                                     # Implementation

    @type_safe
    def update_lets_status(self                            ,                     # Update status
                           status: Schema__LETS__Status
                      ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def get_lets_status(self                         ,                           # Get status
                        name: Safe_Str__LETS__Name
                   ) -> Schema__LETS__Status:
        pass                                                                     # Implementation

    @type_safe
    def layer(self                            ,                                  # Get layer
              layer_name: Safe_Str__Layer_Name
         ) -> Html_Cache__Layer:
        return Html_Cache__Layer(document   = self      ,
                                 layer_name = layer_name)
```

### Html_Cache__Layer

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Html_Cache__Layer - Single layer access
# ═══════════════════════════════════════════════════════════════════════════════

class Html_Cache__Layer(Type_Safe):                                              # Layer accessor
    document   : Html_Cache__Document                                            # Parent
    layer_name : Safe_Str__Layer_Name                                            # Layer ID

    @type_safe
    def save_json(self                     ,                                     # Save JSON
                  file_id : Safe_Str__Id   ,
                  data    : Type_Safe
             ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def load_json(self                   ,                                       # Load JSON
                  file_id: Safe_Str__Id
             ) -> Type_Safe:
        pass                                                                     # Implementation

    @type_safe
    def save_string(self                       ,                                 # Save string
                    file_id : Safe_Str__Id     ,
                    content : Safe_Str__Html
               ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def load_string(self                   ,                                     # Load string
                    file_id: Safe_Str__Id
               ) -> Safe_Str__Html:
        pass                                                                     # Implementation

    @type_safe
    def exists(self                    ,                                         # Check exists
               file_id : Safe_Str__Id
          ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def delete(self                    ,                                         # Delete file
               file_id : Safe_Str__Id
          ) -> bool:
        pass                                                                     # Implementation
```

### Html_Cache__Client

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Html_Cache__Client - Wraps cache service API
# ═══════════════════════════════════════════════════════════════════════════════

class Html_Cache__Client(Type_Safe):                                             # Client wrapper
    cache_client   : Cache__Service__Fast_API__Client                            # Official client
    hash_generator : Cache__Hash__Generator                                      # Hash generator

    @type_safe
    def find_by_cache_key(self                           ,                       # Find by key
                          namespace : Safe_Str__Namespace,
                          cache_key : Safe_Str__Cache_Key
                     ) -> Cache_Id:
        pass                                                                     # Implementation

    @type_safe
    def create_entry(self                                     ,                  # Create entry
                     namespace       : Safe_Str__Namespace    ,
                     cache_key       : Safe_Str__Cache_Key    ,
                     file_id         : Safe_Str__Id           ,
                     json_field_path : Safe_Str__Id           ,
                     entry           : Schema__Html_Cache__Entry
                ) -> Cache_Id:
        pass                                                                     # Implementation

    @type_safe
    def retrieve_entry(self                           ,                          # Get entry
                       cache_id  : Cache_Id           ,
                       namespace : Safe_Str__Namespace
                  ) -> Schema__Html_Cache__Root:
        pass                                                                     # Implementation

    @type_safe
    def update_entry(self                           ,                            # Update entry
                     cache_id  : Cache_Id           ,
                     namespace : Safe_Str__Namespace,
                     data      : Type_Safe
                ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def store_child_json(self                              ,                     # Store child JSON
                         namespace    : Safe_Str__Namespace,
                         cache_id     : Cache_Id           ,
                         data_key     : Safe_Str__LETS__Data_Key,
                         data_file_id : Safe_Str__Id       ,
                         data         : Type_Safe
                    ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def retrieve_child_json(self                              ,                  # Get child JSON
                            namespace    : Safe_Str__Namespace,
                            cache_id     : Cache_Id           ,
                            data_key     : Safe_Str__LETS__Data_Key,
                            data_file_id : Safe_Str__Id
                       ) -> Type_Safe:
        pass                                                                     # Implementation

    @type_safe
    def store_child_string(self                              ,                   # Store string
                           namespace    : Safe_Str__Namespace,
                           cache_id     : Cache_Id           ,
                           data_key     : Safe_Str__LETS__Data_Key,
                           data_file_id : Safe_Str__Id       ,
                           content      : Safe_Str__Html
                      ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def retrieve_child_string(self                              ,                # Get string
                              namespace    : Safe_Str__Namespace,
                              cache_id     : Cache_Id           ,
                              data_key     : Safe_Str__LETS__Data_Key,
                              data_file_id : Safe_Str__Id
                         ) -> Safe_Str__Html:
        pass                                                                     # Implementation

    @type_safe
    def child_exists(self                              ,                         # Check exists
                     namespace    : Safe_Str__Namespace,
                     cache_id     : Cache_Id           ,
                     data_key     : Safe_Str__LETS__Data_Key,
                     data_file_id : Safe_Str__Id
                ) -> bool:
        pass                                                                     # Implementation

    @type_safe
    def delete_child(self                              ,                         # Delete child
                     namespace    : Safe_Str__Namespace,
                     cache_id     : Cache_Id           ,
                     data_key     : Safe_Str__LETS__Data_Key,
                     data_file_id : Safe_Str__Id
                ) -> bool:
        pass                                                                     # Implementation
```

---

## 12. API Integration

### Extended Request Schema

```python
# ═══════════════════════════════════════════════════════════════════════════════
# Extended API Request with Cache Settings
# ═══════════════════════════════════════════════════════════════════════════════

class Schema__Graph__From_Html__Request(Type_Safe):                              # Existing request
    html : Safe_Str__Html                                                        # HTML content


class Schema__Graph__From_Html__Request__With_Cache(Type_Safe):                  # Extended request
    html           : Safe_Str__Html                                              # HTML content
    cache_settings : Schema__Html_Cache__Settings = None                         # Cache settings
```

### API Handler Pattern

```python
# ═══════════════════════════════════════════════════════════════════════════════
# API Handler with Caching
# ═══════════════════════════════════════════════════════════════════════════════

@router.post("/graph/from/html/to/{engine}/{transformation}")
def from_html_to_transformation(engine         : Safe_Str__Id                              ,
                                transformation : Safe_Str__Id                              ,
                                request        : Schema__Graph__From_Html__Request__With_Cache
                           ) -> Schema__Graph__Response:

    # Create cache document if enabled
    document = None
    if request.cache_settings and request.cache_settings.enabled:
        document = Html_Cache__Document(client    = get_cache_client()               ,
                                        namespace = request.cache_settings.namespace ,
                                        cache_key = request.cache_settings.cache_key ,
                                        file_id   = request.cache_settings.file_id   )
        if request.cache_settings.cache_id:
            document.cache_id = request.cache_settings.cache_id

    # Create executor with optional caching
    executor = Html_LETS__Executor(document = document)

    # Get profile
    profile = get_profile(request.cache_settings.profile_id if request.cache_settings else 'default')

    # Execute pipeline
    context = Schema__LETS__Input__Html(html = request.html)
    results = executor.execute_profile(profile = profile,
                                       context = context)

    # Return response with cache info
    return Schema__Graph__Response(output   = results[-1].output,
                                   cache_id = document.cache_id if document else None,
                                   stats    = results                                 )
```

---

## 13. Package Structure

```
mgraph_ai_service_html_graph/
│
├── lets/                                        # LETS Framework
│   ├── __init__.py
│   │
│   ├── base/
│   │   ├── __init__.py
│   │   ├── Html_LETS__Base.py                  # Base LETS class
│   │   └── Html_LETS__Executor.py              # Pipeline executor
│   │
│   ├── implementations/
│   │   ├── __init__.py
│   │   ├── Html_LETS__Html__From__Raw.py       # Raw HTML input
│   │   ├── Html_LETS__Html__From__Url.py       # URL fetch
│   │   ├── Html_LETS__Html__To__Dict.py        # HTML → Dict
│   │   ├── Html_LETS__Dict__To__MGraph.py      # Dict → MGraph
│   │   ├── Html_LETS__MGraph__To__Html_Dict.py # MGraph → Dict
│   │   ├── Html_LETS__MGraph__To__Html.py      # MGraph → HTML
│   │   └── Html_LETS__Html_Dict__To__Html.py   # Dict → HTML
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── Schema__LETS__Input.py              # Base input
│   │   ├── Schema__LETS__Output.py             # Base output
│   │   ├── Schema__LETS__Config.py             # LETS config
│   │   ├── Schema__LETS__Status.py             # Execution status
│   │   └── Schema__LETS__Result.py             # Execution result
│   │
│   ├── enums/
│   │   ├── __init__.py
│   │   └── Enum__Html_LETS__Type.py            # LETS type enum
│   │
│   └── safe_str/
│       ├── __init__.py
│       ├── Safe_Str__LETS__Name.py             # LETS name
│       └── Safe_Str__LETS__Data_Key.py         # Data key
│
├── cache_storage/                               # Cache Storage Layer
│   ├── __init__.py
│   │
│   ├── Html_Cache__Document.py                 # Document manager
│   ├── Html_Cache__Layer.py                    # Layer accessor
│   ├── Html_Cache__Client.py                   # Client wrapper
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   ├── Schema__Html_Cache__Root.py         # Root document
│   │   ├── Schema__Html_Cache__Entry.py        # Entry creation
│   │   └── Schema__Html_Cache__Settings.py     # API settings
│   │
│   ├── enums/
│   │   ├── __init__.py
│   │   └── Enum__Source_Type.py                # Source type
│   │
│   └── safe_str/
│       ├── __init__.py
│       ├── Safe_Str__Cache_Key.py              # Cache key
│       └── Safe_Str__Layer_Name.py             # Layer name
│
├── profiles/                                    # Profiles System
│   ├── __init__.py
│   │
│   ├── Html_LETS__Profile__Registry.py         # Profile registry
│   │
│   ├── schemas/
│   │   ├── __init__.py
│   │   └── Schema__LETS__Profile.py            # Profile definition
│   │
│   └── profiles/
│       ├── __init__.py
│       ├── profile__html_to_dict.py            # Built-in profiles
│       ├── profile__html_to_mgraph.py
│       ├── profile__full_roundtrip.py
│       └── profile__url_to_mgraph.py
│
└── tests/
    ├── unit/
    │   ├── lets/
    │   ├── cache_storage/
    │   └── profiles/
    └── integration/
        └── test_full_pipeline.py
```

---

## 14. Implementation Checklist

### Phase 1: Foundation

- [ ] Create `Safe_Str__LETS__Name`
- [ ] Create `Safe_Str__LETS__Data_Key`
- [ ] Create `Safe_Str__Cache_Key`
- [ ] Create `Safe_Str__Layer_Name`
- [ ] Create `Schema__LETS__Input` / `Schema__LETS__Output`
- [ ] Create `Schema__LETS__Config`
- [ ] Create `Schema__LETS__Status`
- [ ] Create `Schema__LETS__Result`

### Phase 2: LETS Framework

- [ ] Create `Html_LETS__Base`
- [ ] Create `Enum__Html_LETS__Type`
- [ ] Implement `Html_LETS__Html__To__Dict`
- [ ] Implement `Html_LETS__Dict__To__MGraph`
- [ ] Create `Html_LETS__Executor`
- [ ] Write unit tests for LETS (no cache)

### Phase 3: Cache Storage

- [ ] Create `Schema__Html_Cache__Root`
- [ ] Create `Schema__Html_Cache__Entry`
- [ ] Create `Schema__Html_Cache__Settings`
- [ ] Create `Enum__Source_Type`
- [ ] Create `Dict__LETS__Status__By_Name`
- [ ] Implement `Html_Cache__Client`
- [ ] Implement `Html_Cache__Layer`
- [ ] Implement `Html_Cache__Document`
- [ ] Write unit tests with in-memory cache

### Phase 4: Profiles

- [ ] Create `Schema__LETS__Profile`
- [ ] Create `Html_LETS__Profile__Registry`
- [ ] Define built-in profiles
- [ ] Write profile tests

### Phase 5: Integration

- [ ] Extend API request schemas
- [ ] Update API handlers
- [ ] Write integration tests
- [ ] Performance testing

### Phase 6: Remaining LETS

- [ ] Implement `Html_LETS__Html__From__Raw`
- [ ] Implement `Html_LETS__Html__From__Url`
- [ ] Implement `Html_LETS__MGraph__To__Html_Dict`
- [ ] Implement `Html_LETS__MGraph__To__Html`
- [ ] Implement `Html_LETS__Html_Dict__To__Html`

---

## Summary

This architecture provides:

1. **LETS Framework**: A clean, composable transformation pattern
2. **Cache Storage**: Two-tier storage with full provenance
3. **Profiles**: Configurable pipeline definitions
4. **Type Safety**: No raw primitives, full validation
5. **Independence**: LETS works without cache, cache works without LETS

The key insight is **separation of concerns**: LETS defines *what* transformations to do, Cache Storage defines *where* to store results. They integrate but don't depend on each other.

---

*Document generated: January 2026*  
*Ready for implementation*
